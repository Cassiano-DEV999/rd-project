<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Detalhes - ' + ${obra.nomeObra}">Detalhes da Obra</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="app-layout">

<header class="navbar">
    <a th:href="@{/dashboard}" class="navbar-brand">CalculadoraObras</a>
    <nav class="navbar-nav">
        <span>Olá, <strong th:text="${#authentication.name}">Usuário</strong>!</span>
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn-logout">Sair</button>
        </form>
    </nav>
</header>

<main class="container-app">

    <a th:href="@{/dashboard}" class="back-link">&larr; Voltar para o Dashboard</a>

    <div class="page-header">
        <h1 th:text="${obra.nomeObra}">Nome da Obra</h1>
        <p th:if="${obra.endereco}" th:text="${obra.endereco}">Endereço da Obra</p>
    </div>

    <section class="card">
        <h2>Adicionar Material</h2>

        <div th:if="${sucessoMaterial}" class="alert alert-success" th:text="${sucessoMaterial}"></div>
        <div th:if="${erroMaterial}" class="alert alert-danger" th:text="${erroMaterial}"></div>

        <form th:action="@{/obras/{id}/materiais/criar(id=${obra.id})}" th:object="${novoMaterialDto}" method="post">

            <div class="form-group">
                <label for="descricao">Descrição (Ex: Cimento, Tijolo):</label>
                <input type="text" id="descricao" th:field="*{descricao}">
                <div th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}" class="alert alert-danger" style="margin-top: 5px; padding: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="quantidadeComprada">Quantidade Comprada:</label>
                <input type="number" step="0.01" id="quantidadeComprada" th:field="*{quantidadeComprada}">
                <div th:if="${#fields.hasErrors('quantidadeComprada')}" th:errors="*{quantidadeComprada}" class="alert alert-danger" style="margin-top: 5px; padding: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="unidade">Unidade:</label>
                <select id="unidade" th:field="*{unidade}">
                    <option value="">Selecione a unidade</option>
                    <option th:each="unidadeOpt : ${T(com.upx.RD.model.Unidade).values()}"
                            th:value="${unidadeOpt}"
                            th:text="${unidadeOpt.name()}">KG</option>
                </select>
                <div th:if="${#fields.hasErrors('unidade')}" th:errors="*{unidade}" class="alert alert-danger" style="margin-top: 5px; padding: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="percentualDesperdicio">% de Desperdício (Lixo/Entulho - Ex: 30):</label>
                <input type="number" step="0.1" id="percentualDesperdicio" th:field="*{percentualDesperdicio}">
                <div th:if="${#fields.hasErrors('percentualDesperdicio')}" th:errors="*{percentualDesperdicio}" class="alert alert-danger" style="margin-top: 5px; padding: 5px;"></div>
            </div>

            <div class="form-group">
                <label for="percentualSobra">% de Sobra (do Utilizável - Ex: 20):</label>
                <input type="number" step="0.1" id="percentualSobra" th:field="*{percentualSobra}">
                <div th:if="${#fields.hasErrors('percentualSobra')}" th:errors="*{percentualSobra}" class="alert alert-danger" style="margin-top: 5px; padding: 5px;"></div>
            </div>

            <button type="submit" class="btn">Adicionar Material</button>
        </form>
    </section>

    <section class="card">
        <h2>Materiais da Obra</h2>

        <div th:if="${#lists.isEmpty(materiais)}" class="alert alert-success"
             style="background-color: #e6f7ff; color: #0056b3; text-align: center;">
            Nenhum material cadastrado para esta obra.
        </div>

        <table class="materiais-table" th:unless="${#lists.isEmpty(materiais)}">
            <thead>
            <tr>
                <th>Material</th>
                <th>Qtd. Comprada</th>
                <th>% Desperd.</th>
                <th>% Sobra</th>
                <th class="col-calculado col-desperdicio">Desperdício (Lixo)</th>
                <th class="col-calculado col-sobra">Sobra (Potencial)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="mat : ${materiais}">
                <td th:text="${mat.descricao}">Cimento Votoran</td>
                <td th:text="${#numbers.formatDecimal(mat.quantidadeComprada, 1, 2)} + ' ' + ${mat.unidade.name()}">1000.00 KG</td>
                <td th:text="${#numbers.formatDecimal(mat.percentualDesperdicio, 1, 1)} + '%'">30.0%</td>
                <td th:text="${#numbers.formatDecimal(mat.percentualSobra, 1, 1)} + '%'">20.0%</td>
                <td class="col-calculado col-desperdicio"
                    th:text="${#numbers.formatDecimal(mat.getQuantidadeDesperdicioCalculado(), 1, 2)} + ' ' + ${mat.unidade.name()}">
                    300.00 KG
                </td>
                <td class="col-calculado col-sobra"
                    th:text="${#numbers.formatDecimal(mat.getQuantidadeSobraCalculada(), 1, 2)} + ' ' + ${mat.unidade.name()}">
                    140.00 KG
                </td>
            </tr>
            </tbody>
        </table>
    </section>


    <section class="card">
        <h2>Post de Sobras Agrupadas</h2>

        <div th:if="${sucessoPost}" class="alert alert-success" th:text="${sucessoPost}"></div>
        <div th:if="${erroPost}" class="alert alert-danger" th:text="${erroPost}"></div>

        <div th:if="${obra.postDeSobra != null}" class="alert alert-success">
            Um post agrupado para esta obra já foi criado!
            <br>
            <strong>Título:</strong> <span th:text="${obra.postDeSobra.titulo}"></span>
            <br>
            <strong>Valor Total:</strong> R$ <span th:text="${#numbers.formatDecimal(obra.postDeSobra.precoTotal, 1, 2)}"></span>
        </div>

        <form th:action="@{/obras/{id}/criar-post(id=${obra.id})}" method="post"
              th:unless="${obra.postDeSobra != null}">

            <p>Crie um post único agrupando todas as sobras calculadas desta obra. Este post será visível para outros usuários.</p>

            <div class="form-group">
                <label for="precoTotal">Valor (R$) do Pacote Total de Sobras:</label>
                <input type="number" step="0.01" min="0" id="precoTotal" name="precoTotal" required
                       style="width: 200px; font-size: 1.1rem;">
            </div>

            <button type="submit" class="btn">Criar Post Agrupado</button>
        </form>
    </section>

</main>

</body>
</html>